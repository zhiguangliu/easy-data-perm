# 通用数据权限组件
## 概述

数据权限与功能权限相比，复杂性更高。

按控制对象划分，可以分为行权限和列权限两类，行权限是只用户可以看到某一行的数据，列权限是指这些行中，用户可以看到哪些列的数据。

按控制的操作类型划分，可以分为查询操作权限，插入操作权限、修改操作权限。

目前我们仅实现了对查询操作的行权限控制，其他控制暂未实现。

我们可以实现与业务系统松耦合的情况下，对业务代码无侵入的权限控制。

## 场景描述

嬴总开了一家公司，产品行销全国，需要分区域管理。公司的销售部由嬴总直接担任总监，下面设置了三个销售经理刘大（负责东北）、关二（负责华北）、张三（负责西北）。每个人手下都有若干销售，每个省至少有一名销售负责，对于一些大省由多名销售共同负责。

之前为了便于客户管理，公司开发了crm系统，但是当时业务没有这么大，crm没有做数据权限方面的设计。所有人都可以看到所有的客户数据。现在需要增加数据权限控制，让嬴总可以看到所有客户数据，销售经理可以看到自己负责区域的客户数据，负责全省的销售可以看全省数据，多个销售负责一个省的，每个销售只能看到自己负责的那部分数据。

## 需求分析

1. 客户信息有所属省份和维系人这两个字段可以用来做权限控制
2. 对于嬴总，数据权限是“不控制”
3. 对于销售经理，数据权限是 所属省份 in (A省,B省,C省)
4. 对于负责全省的销售，数据权限是 所属省份=A省
5. 对于负责一个省的部分客户的销售，数据权限是 所属省份=A省 and 维系人=销售员id

## 测试数据

用户数据：

| 用户id | 用户名 | 职务     | 负责区域                 |
| ------ | ------ | -------- | ------------------------ |
| 1      | 嬴总   | 销售总监 | 所有                     |
| 2      | 刘大   | 销售经理 | 负责东北（黑吉辽）       |
| 3      | 关二   | 销售经理 | 负责华北（京津冀蒙晋鲁） |
| 4      | 张三   | 销售经理 | 负责西北（陕甘青宁新）   |
| 5      | 李四   | 销售员   | 北京城区                 |
| 6      | 朱五   | 销售员   | 北京郊区                 |
| 7      | 杨六   | 销售员   | 天津                     |
| 8      | 牛七   | 销售员   | 河北                     |
| 9      | 马八   | 销售员   | 内蒙                     |
| 10     | 侯九   | 销售员   | 山西                     |

客户数据：

| 客户id | 客户名称           | 所属省份 | 创建人id | 维系人id |
| ------ | ------------------ | -------- | -------- | -------- |
| 1      | 北京雾灵山有限公司 | 京       | 1        | 6        |
| 2      | 北京慕田峪有限公司 | 京       | 1        | 6        |
| 3      | 北京景山有限公司   | 京       | 1        | 5        |
| 4      | 天津盘山有限公司   | 津       | 1        | 7        |
| 5      | 河北燕山有限公司   | 冀       | 1        | 8        |
| 6      | 河北狼牙山有限公司 | 冀       | 1        | 8        |
| 7      | 内蒙贺兰山有限公司 | 蒙       | 1        | 9        |
| 8      | 内蒙阴山有限公司   | 蒙       | 1        | 9        |
| 9      | 山西五台山有限公司 | 晋       | 1        | 10       |
| 10     | 山西恒山有限公司   | 晋       | 1        | 10       |

### 数据权限组件的功能

数据权限组件就是让上面的这些权限条件可以在界面上配置，然后利用插件将权限条件拼装进待执行的sql中。实现“查询航班”的逻辑与“控制权限”的逻辑分离，在不影响业务查询条件的基础上，实现了对数据权限的控制。

要实现独立的数据权限控制有这么几个难点：              

1. 条件如何管理
   1. 不同的条件如何保存
   2. 不同的关系如何组合
2. 条件如何拼装进基础查询sql

为了解决第一个问题，我们将整个过程抽象成如下模型：

1. 最底层是“数据权限元数据层”。这层定义了需要控制权限的表中那些字段需要控制条件，即sql条件的左值，一般会有多个字段；
2. 第二层是“数据权限层”。这层指定了条件的剩余部分，即sql条件的运算符和右值。按需设置，不是元数据层的所有字段都要设置，多个字段的条件之间是“且”的关系；
3. 第三层是“数据权限角色层”。这一层根据业务需求，对数据权限进行了组合，形成了一个条件组，同组中的数据权限是“或”的关系。
4. 第四层是“用户与角色关系”层，这里将用户关联到角色，多个角色之间的条件是“或”的关系。

为了解决第二个问题，我们引入了阿里的druid，利用他的sql解析功能，将权限条件拼装进原sql中。

## 功能和架构设计

- 数据权限条件要在查询执行之前生效

  数据权限针对的是查询数据的过程，而不是处理数据的过程。所以，要在sql查询之前，对sql进行处理，将权限加进去，而不是在查询到数据之后，再按照权限进行过滤。

- 数据权限的取值要可以动态控制

- 

  

  但是要做出一个可以通用的权限控制系统，有下面几个难点：
  
  1. 

- 列查询权限

# 不控制和授权所有值有什么区别
不控制是更高级别的控制，这个字段对所有人，都是可见的，不会加任何条件。
所有值是相对低级别的控制，是设置在角色上的，可以在对所有人控制权限的基础上，对专门的角色或人设置“所有值”以实现开放权限。

